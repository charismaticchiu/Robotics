<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Aria: actsColorFollowingExample.cpp</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>actsColorFollowingExample.cpp</h1>Connects to the ACTS program, and uses an <a class="el" href="classArAction.html">ArAction</a> subclass to drive the robot towards the largest detected blob.<p>
<div class="fragment"><pre class="fragment">
<span class="preprocessor">#include "Aria.h"</span>



<span class="comment">// Chase is an action that moves the robot toward the largest blob that</span>
<span class="comment">// appears in it's current field of view.</span>
<span class="keyword">class </span>Chase : <span class="keyword">public</span> <a name="_a50"></a><a class="code" href="classArAction.html">ArAction</a>
{
  
<span class="keyword">public</span>:
  
  <span class="comment">// The state of the chase action</span>
  <span class="keyword">enum</span> State {
    NO_TARGET,      <span class="comment">// There is no target in view</span>
    TARGET,         <span class="comment">// This is a target in view</span>
  };

  <span class="comment">// Constructor</span>
  Chase(<a name="_a51"></a><a class="code" href="classArACTS__1__2.html">ArACTS_1_2</a> *acts, <a name="_a52"></a><a class="code" href="classArVCC4.html">ArVCC4</a> *camera);
  
  <span class="comment">// Destructor</span>
  ~Chase(<span class="keywordtype">void</span>);
  
  <span class="comment">// The action</span>
  <a name="_a53"></a><a class="code" href="classArActionDesired.html">ArActionDesired</a> *fire(<a class="code" href="classArActionDesired.html">ArActionDesired</a> currentDesired);

  <span class="comment">// Set the ACTS channel that we want to get blob info from</span>
  <span class="keywordtype">bool</span> setChannel(<span class="keywordtype">int</span> channel);

  <span class="comment">// Return the current state of this action</span>
  State getState(<span class="keywordtype">void</span>) { <span class="keywordflow">return</span> myState; }

  <span class="comment">// Height and width of pixels from frame-grabber</span>
  <span class="keyword">enum</span> {
    WIDTH = 160,
    HEIGHT = 120
  };

<span class="keyword">protected</span>:
  <a class="code" href="classArActionDesired.html">ArActionDesired</a> myDesired;
  <a class="code" href="classArACTS__1__2.html">ArACTS_1_2</a> *myActs;
  <a class="code" href="classArVCC4.html">ArVCC4</a> *myCamera;
  <a name="_a54"></a><a class="code" href="classArTime.html">ArTime</a> myLastSeen;
  State myState;
  <span class="keywordtype">int</span> myChannel;
  <span class="keywordtype">int</span> myMaxTime;
};


<span class="comment">// Constructor: Initialize the chase action</span>
Chase::Chase(<a class="code" href="classArACTS__1__2.html">ArACTS_1_2</a> *acts, <a class="code" href="classArVCC4.html">ArVCC4</a> *camera) :
    <a class="code" href="classArAction.html">ArAction</a>(<span class="stringliteral">"Chase"</span>, <span class="stringliteral">"Chases the largest blob."</span>)
{
  myActs = acts;
  myCamera = camera;
  myChannel = 0;
  myState = NO_TARGET;
  setChannel(1);
  myLastSeen.setToNow();
  myMaxTime = 1000;
}

<span class="comment">// Destructor</span>
Chase::~Chase(<span class="keywordtype">void</span>) {}


<span class="comment">// The chase action</span>
<a class="code" href="classArActionDesired.html">ArActionDesired</a> *<a name="a55"></a><a class="code" href="classArAction.html#a3">Chase::fire</a>(<a class="code" href="classArActionDesired.html">ArActionDesired</a> currentDesired)
{
  <a name="_a56"></a><a class="code" href="classArACTSBlob.html">ArACTSBlob</a> blob;
  <a class="code" href="classArACTSBlob.html">ArACTSBlob</a> largestBlob;

  <span class="keywordtype">bool</span> flag = <span class="keyword">false</span>;

  <span class="keywordtype">int</span> numberOfBlobs;
  <span class="keywordtype">int</span> blobArea = 10;

  <span class="keywordtype">double</span> xRel, yRel;

  <span class="comment">// Reset the desired action</span>
  myDesired.reset();
  
  numberOfBlobs = myActs-&gt;getNumBlobs(myChannel);

  <span class="comment">// If there are blobs to be seen, set the time to now</span>
  <span class="keywordflow">if</span>(numberOfBlobs != 0)
  {
    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; numberOfBlobs; i++)
    {
      myActs-&gt;getBlob(myChannel, i + 1, &amp;blob);
      <span class="keywordflow">if</span>(blob.<a name="a57"></a><a class="code" href="classArACTSBlob.html#a1">getArea</a>() &gt; blobArea)
      {
        flag = <span class="keyword">true</span>;
        blobArea = blob.<a class="code" href="classArACTSBlob.html#a1">getArea</a>();
        largestBlob = blob;
      }
    }

    myLastSeen.setToNow();
  }

  <span class="comment">// If we have not seen a blob in a while...</span>
  <span class="keywordflow">if</span> (myLastSeen.mSecSince() &gt; myMaxTime)
  {
    <span class="keywordflow">if</span>(myState != NO_TARGET) <a name="a58"></a><a class="code" href="classArLog.html#e4">ArLog::log</a>(<a name="a59"></a><a class="code" href="classArLog.html#w2w5">ArLog::Normal</a>, <span class="stringliteral">"Target Lost"</span>);
    myState = NO_TARGET;
  }
  <span class="keywordflow">else</span>
  {
    <span class="comment">// If we see a blob and haven't seen one before..</span>
    <span class="keywordflow">if</span>(myState != TARGET) {
      <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w5">ArLog::Normal</a>, <span class="stringliteral">"Target Aquired"</span>);
      <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w5">ArLog::Normal</a>, <span class="stringliteral">"(Using channel %d with %d blobs)"</span>, myChannel, numberOfBlobs);
    }
    myState = TARGET;
  }

  <span class="keywordflow">if</span>(myState == TARGET &amp;&amp; flag == <span class="keyword">true</span>)
  { 
    <span class="comment">// Determine where the largest blob's center of gravity</span>
    <span class="comment">// is relative to the center of the camera</span>
    xRel = (double)(largestBlob.<a name="a60"></a><a class="code" href="classArACTSBlob.html#a6">getXCG</a>() - WIDTH/2.0)  / (double)WIDTH;
    yRel = (double)(largestBlob.<a name="a61"></a><a class="code" href="classArACTSBlob.html#a7">getYCG</a>() - HEIGHT/2.0) / (double)HEIGHT;
      
    <span class="comment">// Tilt the camera toward the blob</span>
    <span class="keywordflow">if</span>(!(<a name="a62"></a><a class="code" href="classArMath.html#e7">ArMath::fabs</a>(yRel) &lt; .20))
    {
      <span class="keywordflow">if</span> (-yRel &gt; 0)
        myCamera-&gt;tiltRel(1);
      <span class="keywordflow">else</span>
        myCamera-&gt;tiltRel(-1);
    }

    <span class="comment">// Set the heading and velocity for the robot</span>
    <span class="keywordflow">if</span> (<a class="code" href="classArMath.html#e7">ArMath::fabs</a>(xRel) &lt; .10)
    {
      myDesired.setDeltaHeading(0);
    }
    <span class="keywordflow">else</span>
    {
      <span class="keywordflow">if</span> (<a class="code" href="classArMath.html#e7">ArMath::fabs</a>(-xRel * 10) &lt;= 10)
        myDesired.setDeltaHeading(-xRel * 10);
      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (-xRel &gt; 0)
        myDesired.setDeltaHeading(10);
      <span class="keywordflow">else</span>
        myDesired.setDeltaHeading(-10);
     
    }

    myDesired.setVel(200);
    <span class="keywordflow">return</span> &amp;myDesired;    
  }

  <span class="comment">// If we have no target, then don't set any action and let lower priority</span>
  <span class="comment">// actions (e.g. stop) control the robot.</span>
  <span class="keywordflow">return</span> &amp;myDesired;
}

<span class="comment">// Set the channel that the blob info will be obtained from</span>
<span class="keywordtype">bool</span> Chase::setChannel(<span class="keywordtype">int</span> channel)
{
  <span class="keywordflow">if</span> (channel &gt;= 1 &amp;&amp; channel &lt;= <a name="a63"></a><a class="code" href="classArACTS__1__2.html#w1w5">ArACTS_1_2::NUM_CHANNELS</a>)
  {
    myChannel = channel;
    <span class="keywordflow">return</span> <span class="keyword">true</span>;
  }
  <span class="keywordflow">else</span>
    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}




<span class="comment">// Callback to enable/disable the keyboard driving action</span>
<span class="keywordtype">void</span> toggleAction(<a class="code" href="classArAction.html">ArAction</a>* action)
{
  <span class="keywordflow">if</span>(action-&gt;isActive()) {
    action-&gt;deactivate();
    <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w5">ArLog::Normal</a>, <span class="stringliteral">"%s action is now deactivated."</span>, action-&gt;getName());
  }
  <span class="keywordflow">else</span> {
    action-&gt;activate();
    <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w5">ArLog::Normal</a>, <span class="stringliteral">"%s action is now activated."</span>, action-&gt;getName());
  }
}



<span class="comment">// Main function</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)
{
  <a name="a64"></a><a class="code" href="classAria.html#e23">Aria::init</a>();

  <span class="comment">// The robot</span>
  <a name="_a65"></a><a class="code" href="classArRobot.html">ArRobot</a> robot;

  <span class="comment">// A key handler to take input from keyboard</span>
  <a name="_a66"></a><a class="code" href="classArKeyHandler.html">ArKeyHandler</a> keyHandler;
  <a name="a67"></a><a class="code" href="classAria.html#e33">Aria::setKeyHandler</a>(&amp;keyHandler);

  <span class="comment">// Sonar for basic obstacle avoidance</span>
  <a name="_a68"></a><a class="code" href="classArSonarDevice.html">ArSonarDevice</a> sonar;

  <span class="comment">// The camera (Cannon VC-C4)</span>
  <a class="code" href="classArVCC4.html">ArVCC4</a> vcc4 (&amp;robot);

  <span class="comment">// ACTS, for tracking blobs of color</span>
  <a class="code" href="classArACTS__1__2.html">ArACTS_1_2</a> acts;

  <span class="comment">// command line arguments</span>
  <a name="_a69"></a><a class="code" href="classArArgumentParser.html">ArArgumentParser</a> argParser(&amp;argc, argv);
  argParser.loadDefaultArguments();
  
  <span class="comment">// The simple way to connect to things (takes arguments from argParser)</span>
  <a name="_a70"></a><a class="code" href="classArSimpleConnector.html">ArSimpleConnector</a> simpleConnector(&amp;argParser);

  <span class="comment">// Parse the arguments                </span>
  <span class="keywordflow">if</span> (!<a name="a71"></a><a class="code" href="classAria.html#e28">Aria::parseArgs</a>())
  {    
    <a name="a72"></a><a class="code" href="classAria.html#e27">Aria::logOptions</a>();
    keyHandler.<a name="a73"></a><a class="code" href="classArKeyHandler.html#a6">restore</a>();
    <a name="a74"></a><a class="code" href="classAria.html#e37">Aria::shutdown</a>();
    <span class="keywordflow">return</span> 1;
  }

  <span class="comment">// Robot motion limiter actions (if obstacles are detected by sonar)</span>
  <a name="_a75"></a><a class="code" href="classArActionLimiterForwards.html">ArActionLimiterForwards</a> limiter(<span class="stringliteral">"speed limiter near"</span>, 350, 800, 200);
  <a class="code" href="classArActionLimiterForwards.html">ArActionLimiterForwards</a> limiterFar(<span class="stringliteral">"speed limiter far"</span>, 400, 1250, 300);
  ArActionLimiterBackwards backwardsLimiter;
  <a name="_a76"></a><a class="code" href="classArActionConstantVelocity.html">ArActionConstantVelocity</a> stop(<span class="stringliteral">"stop"</span>, 0);
  <span class="comment">//ArActionConstantVelocity backup("backup", -200);</span>
  

  <span class="comment">// The color following action, defined above</span>
  Chase chase(&amp;acts, &amp;vcc4);

  <span class="comment">// Keyboard teleoperation action</span>
  ArActionKeydrive keydriveAction;

  <span class="comment">// Use the "a" key to activate/deactivate keydrive mode</span>
  keyHandler.<a name="a77"></a><a class="code" href="classArKeyHandler.html#a0">addKeyHandler</a>(<span class="charliteral">'a'</span>, <span class="keyword">new</span> <a name="_a78"></a><a class="code" href="classArGlobalFunctor1.html">ArGlobalFunctor1&lt;ArAction*&gt;</a>(&amp;toggleAction, &amp;keydriveAction));

  <span class="comment">// Let Aria know about the key handler</span>
  <a class="code" href="classAria.html#e33">Aria::setKeyHandler</a>(&amp;keyHandler);

  <span class="comment">// Add the key handler to the robot</span>
  robot.<a name="a79"></a><a class="code" href="classArRobot.html#a20">attachKeyHandler</a>(&amp;keyHandler);

  <span class="comment">// Add the sonar to the robot</span>
  robot.<a name="a80"></a><a class="code" href="classArRobot.html#a8">addRangeDevice</a>(&amp;sonar);

  <span class="comment">// Connect to the robot</span>
  <span class="keywordflow">if</span> (!simpleConnector.connectRobot(&amp;robot))
  {
    <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a name="a81"></a><a class="code" href="classArLog.html#w2w8">ArLog::Terse</a>, <span class="stringliteral">"Error: Could not connect to robot... exiting\n"</span>);
    keyHandler.<a class="code" href="classArKeyHandler.html#a6">restore</a>();
    <a name="a82"></a><a class="code" href="classAria.html#e11">Aria::exit</a>(1);
  }

  <span class="comment">// Open a connection to ACTS</span>
  <span class="keywordflow">if</span>(!acts.<a name="a83"></a><a class="code" href="classArACTS__1__2.html#a8">openPort</a>(&amp;robot)) 
  {
    <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w8">ArLog::Terse</a>, <span class="stringliteral">"Error: Could not connect to ACTS... exiting."</span>);
    keyHandler.<a class="code" href="classArKeyHandler.html#a6">restore</a>();
    <a class="code" href="classAria.html#e11">Aria::exit</a>(2);
  }

  <span class="comment">// Initialize the camera</span>
  vcc4.init();

  <span class="comment">// Wait a second.....</span>
  <a name="a84"></a><a class="code" href="classArUtil.html#e47">ArUtil::sleep</a>(1000);

  <span class="comment">// Artificially keep the robot from going too fast</span>
  robot.<a name="a85"></a><a class="code" href="classArRobot.html#a264">setAbsoluteMaxTransVel</a>(400);

  <span class="comment">// Enable the motors</span>
  robot.<a name="a86"></a><a class="code" href="classArRobot.html#a31">comInt</a>(<a name="a87"></a><a class="code" href="classArCommands.html#w6w11">ArCommands::ENABLE</a>, 1);
  
  <span class="comment">// Turn off the amigobot sounds</span>
  robot.<a class="code" href="classArRobot.html#a31">comInt</a>(<a name="a88"></a><a class="code" href="classArCommands.html#w6w77">ArCommands::SOUNDTOG</a>, 0);

  <span class="comment">// Wait....</span>
  <a class="code" href="classArUtil.html#e47">ArUtil::sleep</a>(200);

  <span class="comment">// Add the actions to the robot in descending order of importance.</span>
  robot.<a name="a89"></a><a class="code" href="classArRobot.html#a1">addAction</a>(&amp;limiter, 7);
  robot.<a class="code" href="classArRobot.html#a1">addAction</a>(&amp;limiterFar, 6);
  robot.<a class="code" href="classArRobot.html#a1">addAction</a>(&amp;backwardsLimiter, 5);
  robot.<a class="code" href="classArRobot.html#a1">addAction</a>(&amp;keydriveAction, 4);
  robot.<a class="code" href="classArRobot.html#a1">addAction</a>(&amp;chase, 3);
  robot.<a class="code" href="classArRobot.html#a1">addAction</a>(&amp;stop, 1);

  <span class="comment">// Start with keydrive action disabled. Use the 'a' key to turn it on.</span>
  keydriveAction.<a name="a90"></a><a class="code" href="classArActionKeydrive.html#a2">deactivate</a>();

  <span class="comment">// Run the robot processing cycle until the connection is lost</span>
  <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w5">ArLog::Normal</a>, <span class="stringliteral">"Running. Train ACTS to detect a color to drive towards an object, or use 'a' key to switch to keyboard driving mode."</span>);
  robot.<a name="a91"></a><a class="code" href="classArRobot.html#a254">run</a>(<span class="keyword">true</span>);
  
  <a class="code" href="classAria.html#e37">Aria::shutdown</a>();
  <span class="keywordflow">return</span> 0;
}

</pre></div> <hr size="1"><address style="align: right;"><small>Generated on Thu Jan 7 10:34:37 2010 for Aria by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
