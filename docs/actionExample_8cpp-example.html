<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Aria: actionExample.cpp</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>actionExample.cpp</h1>An example program demonstrating how to make and use new actions.<p>
This example program creates two new actions, Go and Turn. Go will drive the robot forward safely, while Turn will avoid obstacles detected by the sonar by turning. This program also adds a predefined action from <a class="el" href="classAria.html">Aria</a> which tries to recover from stalls (hit something and can't move forward) by backing and turning.<p>
Each of these actions have the normal constructor and destructor, note that the constructors use constructor chaining to create their <a class="el" href="classArAction.html">ArAction</a> part correctly. Each action then also implements the essential virtual method, fire(). This fire function is called by the action resolver, and returns values that, in combination with other actions' desired behavior, determine the driving commands sent to the robot.<p>
Also note that each of these actions override the setRobot function; these implementations obtain the sonar device from the robot in addition to doing the needed caching of the robot pointer. This is what you should do if you care about the presence or absence of a particular sensor. If you don't care about any particular sensor you could just use one of the checkRangeDevice... methods in <a class="el" href="classArRobot.html">ArRobot</a> (there are four of them). Also note that these are very naive actions, they are simply an example of how to use actions.<p>
See the <a class="el" href="main.html#actions">Actions</a> Actions section of the <a class="el" href="classAria.html">Aria</a> reference manual overview for more details about actions.<p>
Note that actions must take a small amount of time to execute, to avoid delaying the robot synchronization cycle.<p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include "Aria.h"</span>

<span class="comment">/* </span>
<span class="comment"> * Action that drives the robot forward, but stops if obstacles are</span>
<span class="comment"> * detected by sonar. </span>
<span class="comment"> */</span>
<span class="keyword">class </span>ActionGo : <span class="keyword">public</span> <a name="_a0"></a><a class="code" href="classArAction.html">ArAction</a>
{
<span class="keyword">public</span>:
  <span class="comment">// constructor, sets myMaxSpeed and myStopDistance</span>
  ActionGo(<span class="keywordtype">double</span> maxSpeed, <span class="keywordtype">double</span> stopDistance);
  <span class="comment">// destructor. does not need to do anything</span>
  <span class="keyword">virtual</span> ~ActionGo(<span class="keywordtype">void</span>) {};
  <span class="comment">// called by the action resolver to obtain this action's requested behavior</span>
  <span class="keyword">virtual</span> <a name="_a1"></a><a class="code" href="classArActionDesired.html">ArActionDesired</a> *fire(<a class="code" href="classArActionDesired.html">ArActionDesired</a> currentDesired);
  <span class="comment">// store the robot pointer, and it's ArSonarDevice object, or deactivate this action if there is no sonar.</span>
  <span class="keyword">virtual</span> <span class="keywordtype">void</span> setRobot(<a name="_a2"></a><a class="code" href="classArRobot.html">ArRobot</a> *robot);
<span class="keyword">protected</span>:
  <span class="comment">// the sonar device object obtained from the robot by setRobot()</span>
  <a name="_a3"></a><a class="code" href="classArRangeDevice.html">ArRangeDevice</a> *mySonar;


  <span class="comment">/* Our current desired action: fire() modifies this object and returns</span>
<span class="comment">      to the action resolver a pointer to this object.</span>
<span class="comment">      This object is kept as a class member so that it persists after fire()</span>
<span class="comment">      returns (otherwise fire() would have to create a new object each invocation,</span>
<span class="comment">      but would never be able to delete that object).</span>
<span class="comment">  */</span>
  <a class="code" href="classArActionDesired.html">ArActionDesired</a> myDesired;

  <span class="keywordtype">double</span> myMaxSpeed;
  <span class="keywordtype">double</span> myStopDistance;
};


<span class="comment">/* Action that turns the robot away from obstacles detected by the </span>
<span class="comment"> * sonar. */</span>
<span class="keyword">class </span>ActionTurn : <span class="keyword">public</span> <a class="code" href="classArAction.html">ArAction</a>
{
<span class="keyword">public</span>:
  <span class="comment">// constructor, sets the turnThreshold, and turnAmount</span>
  ActionTurn(<span class="keywordtype">double</span> turnThreshold, <span class="keywordtype">double</span> turnAmount);
  <span class="comment">// destructor, its just empty, we don't need to do anything</span>
  <span class="keyword">virtual</span> ~ActionTurn(<span class="keywordtype">void</span>) {};
  <span class="comment">// fire, this is what the resolver calls to figure out what this action wants</span>
  <span class="keyword">virtual</span> <a class="code" href="classArActionDesired.html">ArActionDesired</a> *fire(<a class="code" href="classArActionDesired.html">ArActionDesired</a> currentDesired);
  <span class="comment">// sets the robot pointer, also gets the sonar device, or deactivates this action if there is no sonar.</span>
  <span class="keyword">virtual</span> <span class="keywordtype">void</span> setRobot(<a class="code" href="classArRobot.html">ArRobot</a> *robot);
<span class="keyword">protected</span>:
  <span class="comment">// this is to hold the sonar device form the robot</span>
  <a class="code" href="classArRangeDevice.html">ArRangeDevice</a> *mySonar;
  <span class="comment">// what the action wants to do; used by the action resover after fire()</span>
  <a class="code" href="classArActionDesired.html">ArActionDesired</a> myDesired;
  <span class="comment">// distance at which to start turning</span>
  <span class="keywordtype">double</span> myTurnThreshold;
  <span class="comment">// amount to turn when turning is needed</span>
  <span class="keywordtype">double</span> myTurnAmount;
  <span class="comment">// remember which turn direction we requested, to help keep turns smooth</span>
  <span class="keywordtype">int</span> myTurning; <span class="comment">// -1 == left, 1 == right, 0 == none</span>
};

<span class="comment">/*</span>
<span class="comment">  Note the use of constructor chaining with </span>
<span class="comment">  ArAction(actionName). Also note how it uses setNextArgument, which makes it so that </span>
<span class="comment">  other parts of the program could find out what parameters this action has, and possibly modify them.</span>
<span class="comment">*/</span>
ActionGo::ActionGo(<span class="keywordtype">double</span> maxSpeed, <span class="keywordtype">double</span> stopDistance) :
  <a class="code" href="classArAction.html">ArAction</a>(<span class="stringliteral">"Go"</span>)
{
  mySonar = NULL;
  myMaxSpeed = maxSpeed;
  myStopDistance = stopDistance;
  setNextArgument(<a name="_a4"></a><a class="code" href="classArArg.html">ArArg</a>(<span class="stringliteral">"maximum speed"</span>, &amp;myMaxSpeed, <span class="stringliteral">"Maximum speed to go."</span>));
  setNextArgument(<a class="code" href="classArArg.html">ArArg</a>(<span class="stringliteral">"stop distance"</span>, &amp;myStopDistance, <span class="stringliteral">"Distance at which to stop."</span>));
}

<span class="comment">/*</span>
<span class="comment">  Override ArAction::setRobot() to get the sonar device from the robot, or deactivate this action if it is missing.</span>
<span class="comment">  You must also call ArAction::setRobot() to properly store</span>
<span class="comment">  the ArRobot pointer in the ArAction base class.</span>
<span class="comment">*/</span>
<span class="keywordtype">void</span> <a name="a5"></a><a class="code" href="classArAction.html#a14">ActionGo::setRobot</a>(<a class="code" href="classArRobot.html">ArRobot</a> *robot)
{
  <a class="code" href="classArAction.html#a14">ArAction::setRobot</a>(robot);
  mySonar = robot-&gt;<a name="a6"></a><a class="code" href="classArRobot.html#a49">findRangeDevice</a>(<span class="stringliteral">"sonar"</span>);
  <span class="keywordflow">if</span> (robot == NULL)
    {
      <a name="a7"></a><a class="code" href="classArLog.html#e4">ArLog::log</a>(<a name="a8"></a><a class="code" href="classArLog.html#w2w8">ArLog::Terse</a>, <span class="stringliteral">"actionExample: ActionGo: Warning: I found no sonar, deactivating."</span>);
      deactivate();
    }
}

<span class="comment">/*</span>
<span class="comment">  This fire is the whole point of the action.</span>
<span class="comment">  currentDesired is the combined desired action from other actions</span>
<span class="comment">  previously processed by the action resolver.  In this case, we're</span>
<span class="comment">  not interested in that, we will set our desired </span>
<span class="comment">  forward velocity in the myDesired member, and return it.</span>
<span class="comment"></span>
<span class="comment">  Note that myDesired must be a class member, since this method</span>
<span class="comment">  will return a pointer to myDesired to the caller. If we had</span>
<span class="comment">  declared the desired action as a local variable in this method,</span>
<span class="comment">  the pointer we returned would be invalid after this method</span>
<span class="comment">  returned.</span>
<span class="comment">*/</span>
<a class="code" href="classArActionDesired.html">ArActionDesired</a> *<a name="a9"></a><a class="code" href="classArAction.html#a3">ActionGo::fire</a>(<a class="code" href="classArActionDesired.html">ArActionDesired</a> currentDesired)
{
  <span class="keywordtype">double</span> range;
  <span class="keywordtype">double</span> speed;

  <span class="comment">// reset the actionDesired (must be done), to clear</span>
  <span class="comment">// its previous values.</span>
  myDesired.reset();

  <span class="comment">// if the sonar is null we can't do anything, so deactivate</span>
  <span class="keywordflow">if</span> (mySonar == NULL)
  {
    deactivate();
    <span class="keywordflow">return</span> NULL;
  }
  <span class="comment">// get the range of the sonar</span>
  range = mySonar-&gt;currentReadingPolar(-70, 70) - myRobot-&gt;getRobotRadius();
  <span class="comment">// if the range is greater than the stop distance, find some speed to go</span>
  <span class="keywordflow">if</span> (range &gt; myStopDistance)
  {
    <span class="comment">// just an arbitrary speed based on the range</span>
    speed = range * .3;
    <span class="comment">// if that speed is greater than our max, cap it</span>
    <span class="keywordflow">if</span> (speed &gt; myMaxSpeed)
      speed = myMaxSpeed;
    <span class="comment">// now set the velocity</span>
    myDesired.setVel(speed);
  }
  <span class="comment">// the range was less than the stop distance, so request stop</span>
  <span class="keywordflow">else</span>
  {
    myDesired.setVel(0);
  }
  <span class="comment">// return a pointer to the actionDesired to the resolver to make our request</span>
  <span class="keywordflow">return</span> &amp;myDesired;
}


<span class="comment">/*</span>
<span class="comment">  This is the ActionTurn constructor, note the use of constructor chaining </span>
<span class="comment">  with the ArAction. also note how it uses setNextArgument, which makes </span>
<span class="comment">  it so that other things can see what parameters this action has, and </span>
<span class="comment">  set them.  It also initializes the classes variables.</span>
<span class="comment">*/</span>
ActionTurn::ActionTurn(<span class="keywordtype">double</span> turnThreshold, <span class="keywordtype">double</span> turnAmount) :
  <a class="code" href="classArAction.html">ArAction</a>(<span class="stringliteral">"Turn"</span>)
{
  myTurnThreshold = turnThreshold;
  myTurnAmount = turnAmount;
  setNextArgument(<a class="code" href="classArArg.html">ArArg</a>(<span class="stringliteral">"turn threshold (mm)"</span>, &amp;myTurnThreshold, <span class="stringliteral">"The number of mm away from obstacle to begin turnning."</span>));
  setNextArgument(<a class="code" href="classArArg.html">ArArg</a>(<span class="stringliteral">"turn amount (deg)"</span>, &amp;myTurnAmount, <span class="stringliteral">"The number of degress to turn if turning."</span>));
  myTurning = 0;
}

<span class="comment">/*</span>
<span class="comment">  Sets the myRobot pointer (all setRobot overloaded functions must do this),</span>
<span class="comment">  finds the sonar device from the robot, and if the sonar isn't there, </span>
<span class="comment">  then it deactivates itself.</span>
<span class="comment">*/</span>
<span class="keywordtype">void</span> <a class="code" href="classArAction.html#a14">ActionTurn::setRobot</a>(<a class="code" href="classArRobot.html">ArRobot</a> *robot)
{
  <a class="code" href="classArAction.html#a14">ArAction::setRobot</a>(robot);
  mySonar = robot-&gt;<a class="code" href="classArRobot.html#a49">findRangeDevice</a>(<span class="stringliteral">"sonar"</span>);
  <span class="keywordflow">if</span> (mySonar == NULL)
  {
    <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w8">ArLog::Terse</a>, <span class="stringliteral">"actionExample: ActionTurn: Warning: I found no sonar, deactivating."</span>);
    deactivate(); 
  }
}

<span class="comment">/*</span>
<span class="comment">  This is the guts of the Turn action.</span>
<span class="comment">*/</span>
<a class="code" href="classArActionDesired.html">ArActionDesired</a> *<a class="code" href="classArAction.html#a3">ActionTurn::fire</a>(<a class="code" href="classArActionDesired.html">ArActionDesired</a> currentDesired)
{
  <span class="keywordtype">double</span> leftRange, rightRange;
  <span class="comment">// reset the actionDesired (must be done)</span>
  myDesired.reset();
  <span class="comment">// if the sonar is null we can't do anything, so deactivate</span>
  <span class="keywordflow">if</span> (mySonar == NULL)
  {
    deactivate();
    <span class="keywordflow">return</span> NULL;
  }
  <span class="comment">// Get the left readings and right readings off of the sonar</span>
  leftRange = (mySonar-&gt;currentReadingPolar(0, 100) - 
        myRobot-&gt;getRobotRadius());
  rightRange = (mySonar-&gt;currentReadingPolar(-100, 0) - 
        myRobot-&gt;getRobotRadius());
  <span class="comment">// if neither left nor right range is within the turn threshold,</span>
  <span class="comment">// reset the turning variable and don't turn</span>
  <span class="keywordflow">if</span> (leftRange &gt; myTurnThreshold &amp;&amp; rightRange &gt; myTurnThreshold)
  {
    myTurning = 0;
    myDesired.setDeltaHeading(0);
  }
  <span class="comment">// if we're already turning some direction, keep turning that direction</span>
  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myTurning)
  {
    myDesired.setDeltaHeading(myTurnAmount * myTurning);
  }
  <span class="comment">// if we're not turning already, but need to, and left is closer, turn right</span>
  <span class="comment">// and set the turning variable so we turn the same direction for as long as</span>
  <span class="comment">// we need to</span>
  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (leftRange &lt; rightRange)
  {
    myTurning = -1;
    myDesired.setDeltaHeading(myTurnAmount * myTurning);
  }
  <span class="comment">// if we're not turning already, but need to, and right is closer, turn left</span>
  <span class="comment">// and set the turning variable so we turn the same direction for as long as</span>
  <span class="comment">// we need to</span>
  <span class="keywordflow">else</span> 
  {
    myTurning = 1;
    myDesired.setDeltaHeading(myTurnAmount * myTurning);
  }
  <span class="comment">// return a pointer to the actionDesired, so resolver knows what to do</span>
  <span class="keywordflow">return</span> &amp;myDesired;
}



<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)
{
  <a name="a10"></a><a class="code" href="classAria.html#e23">Aria::init</a>();

  <a name="_a11"></a><a class="code" href="classArSimpleConnector.html">ArSimpleConnector</a> conn(&amp;argc, argv);
  <a class="code" href="classArRobot.html">ArRobot</a> robot;
  <a name="_a12"></a><a class="code" href="classArSonarDevice.html">ArSonarDevice</a> sonar;

  <span class="comment">// Create instances of the actions defined above, plus ArActionStallRecover, </span>
  <span class="comment">// a predefined action from Aria.</span>
  ActionGo go(500, 350);
  ActionTurn turn(400, 10);
  <a name="_a13"></a><a class="code" href="classArActionStallRecover.html">ArActionStallRecover</a> recover;

    
  <span class="comment">// Parse all command-line arguments</span>
  <span class="keywordflow">if</span>(!<a name="a14"></a><a class="code" href="classAria.html#e28">Aria::parseArgs</a>())
  {
    <a name="a15"></a><a class="code" href="classAria.html#e27">Aria::logOptions</a>();
    <span class="keywordflow">return</span> 1;
  }
  
  <span class="comment">// Connect to the robot</span>
  <span class="keywordflow">if</span>(!conn.connectRobot(&amp;robot))
  {
    <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w8">ArLog::Terse</a>, <span class="stringliteral">"actionExample: Could not connect to robot! Exiting."</span>);
    <span class="keywordflow">return</span> 2;
  }

  <span class="comment">// Add the range device to the robot. You should add all the range </span>
  <span class="comment">// devices and such before you add actions</span>
  robot.<a name="a16"></a><a class="code" href="classArRobot.html#a8">addRangeDevice</a>(&amp;sonar);

 
  <span class="comment">// Add our actions in order. The second argument is the priority, </span>
  <span class="comment">// with higher priority actions going first, and possibly pre-empting lower</span>
  <span class="comment">// priority actions.</span>
  robot.<a name="a17"></a><a class="code" href="classArRobot.html#a1">addAction</a>(&amp;recover, 100);
  robot.<a class="code" href="classArRobot.html#a1">addAction</a>(&amp;go, 50);
  robot.<a class="code" href="classArRobot.html#a1">addAction</a>(&amp;turn, 49);

  <span class="comment">// Enable the motors, disable amigobot sounds</span>
  robot.<a name="a18"></a><a class="code" href="classArRobot.html#a39">enableMotors</a>();

  <span class="comment">// Run the robot processing cycle.</span>
  <span class="comment">// 'true' means to return if it loses connection,</span>
  <span class="comment">// after which we exit the program.</span>
  robot.<a name="a19"></a><a class="code" href="classArRobot.html#a254">run</a>(<span class="keyword">true</span>);
  
  <a name="a20"></a><a class="code" href="classAria.html#e37">Aria::shutdown</a>();
  <span class="keywordflow">return</span> 0;
}
</pre></div> <hr size="1"><address style="align: right;"><small>Generated on Thu Jan 7 10:34:37 2010 for Aria by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
