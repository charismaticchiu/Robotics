<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Aria: sonyPTZDemo.cpp</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>sonyPTZDemo.cpp</h1>Example using a joystick to operate a Sony PTZ camera<p>
This is basically just a demo of how to use the sony, but made fancy so you can drive around the robot and look at stuff with the camera. Press down button 1 to drive the robot, button 2 to move the camera, and both buttons to zoom the camera.<p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include "Aria.h"</span>


<span class="comment">/*</span>
<span class="comment">  This class is the core of this demo, it adds itself to the robot given</span>
<span class="comment">  as a user task, then drives the robot and camera from the joystick</span>
<span class="comment">*/</span>
<span class="keyword">class </span>Joydrive
{
<span class="keyword">public</span>:
  <span class="comment">// constructor</span>
  Joydrive(<a name="_a577"></a><a class="code" href="classArRobot.html">ArRobot</a> *robot, <span class="keywordtype">int</span> LRAmount = 15, <span class="keywordtype">int</span> UDAmount = 10, 
       <span class="keywordtype">int</span> zoomAmount = 50);
  <span class="comment">// destructor, its just empty</span>
  ~Joydrive(<span class="keywordtype">void</span>) {}

  <span class="comment">// the callback function</span>
  <span class="keywordtype">void</span> drive(<span class="keywordtype">void</span>);

  <span class="comment">// callbacks for key presses</span>
  <span class="keywordtype">void</span> up(<span class="keywordtype">void</span>);
  <span class="keywordtype">void</span> down(<span class="keywordtype">void</span>);
  <span class="keywordtype">void</span> left(<span class="keywordtype">void</span>);
  <span class="keywordtype">void</span> right(<span class="keywordtype">void</span>);
  <span class="keywordtype">void</span> in(<span class="keywordtype">void</span>);
  <span class="keywordtype">void</span> out(<span class="keywordtype">void</span>);
  <span class="keywordtype">void</span> center(<span class="keywordtype">void</span>);
<span class="keyword">protected</span>:
  <span class="comment">// the rotational max for the robot</span>
  <span class="keywordtype">int</span> myRotValRobot;
  <span class="comment">// the translational max for the robot</span>
  <span class="keywordtype">int</span> myTransValRobot;
  <span class="comment">// the pan max for the camera</span>
  <span class="keywordtype">int</span> myPanValCamera;
  <span class="comment">// the tilt max for the camera</span>
  <span class="keywordtype">int</span> myTiltValCamera;
  <span class="comment">// the zoom max for the camera</span>
  <span class="keywordtype">int</span> myZoomValCamera;
  
  <span class="comment">// joystick handler</span>
  <a name="_a578"></a><a class="code" href="classArJoyHandler.html">ArJoyHandler</a> myJoyHandler;

  <span class="comment">// the camera</span>
  <a name="_a579"></a><a class="code" href="classArSonyPTZ.html">ArSonyPTZ</a> myCam;
  <span class="comment">// the robot pointer</span>
  <a class="code" href="classArRobot.html">ArRobot</a> *myRobot;
  <span class="comment">// callback for the drive function</span>
  <a name="_a580"></a><a class="code" href="classArFunctorC.html">ArFunctorC&lt;Joydrive&gt;</a> myDriveCB;
  <a class="code" href="classArFunctorC.html">ArFunctorC&lt;Joydrive&gt;</a> myUpCB;
  <a class="code" href="classArFunctorC.html">ArFunctorC&lt;Joydrive&gt;</a> myDownCB;
  <a class="code" href="classArFunctorC.html">ArFunctorC&lt;Joydrive&gt;</a> myLeftCB;
  <a class="code" href="classArFunctorC.html">ArFunctorC&lt;Joydrive&gt;</a> myRightCB;
  <a class="code" href="classArFunctorC.html">ArFunctorC&lt;Joydrive&gt;</a> myInCB;
  <a class="code" href="classArFunctorC.html">ArFunctorC&lt;Joydrive&gt;</a> myOutCB;
  <a class="code" href="classArFunctorC.html">ArFunctorC&lt;Joydrive&gt;</a> myCenterCB;
  <span class="keywordtype">int</span> myLRAmount;
  <span class="keywordtype">int</span> myUDAmount;
  <span class="keywordtype">int</span> myZoomAmount;
};

<span class="comment">/*</span>
<span class="comment">  Constructor, sets the robot pointer, and some initial values, also note the</span>
<span class="comment">  use of constructor chaining on myCam and myDriveCB.</span>
<span class="comment">*/</span>
Joydrive::Joydrive(<a class="code" href="classArRobot.html">ArRobot</a> *robot, <span class="keywordtype">int</span> LRAmount, <span class="keywordtype">int</span> UDAmount, <span class="keywordtype">int</span> zoomAmount) :
  myCam(robot),
  myDriveCB(this, &amp;Joydrive::drive),
  myUpCB(this, &amp;Joydrive::up),
  myDownCB(this, &amp;Joydrive::down),
  myLeftCB(this, &amp;Joydrive::left),
  myRightCB(this, &amp;Joydrive::right),
  myInCB(this, &amp;Joydrive::in),
  myOutCB(this, &amp;Joydrive::out),
  myCenterCB(this, &amp;Joydrive::center)
    
{
  <span class="comment">// set the robot pointer and add the joydrive as a user task</span>
  myRobot = robot;
  myRobot-&gt;<a name="a581"></a><a class="code" href="classArRobot.html#a12">addUserTask</a>(<span class="stringliteral">"joydrive"</span>, 50, &amp;myDriveCB);
  



  <span class="comment">// initalize some variables</span>
  myRotValRobot = 100;
  myTransValRobot = 700;
  myPanValCamera = 8;
  myTiltValCamera = 3;
  myZoomValCamera = 50;
  myLRAmount = LRAmount;
  myUDAmount = UDAmount;
  myZoomAmount = zoomAmount;

  <a name="_a582"></a><a class="code" href="classArKeyHandler.html">ArKeyHandler</a> *keyHandler;
  myRobot = robot;
  <span class="comment">// see if there is already a keyhandler, if not make one for ourselves</span>
  <span class="keywordflow">if</span> ((keyHandler = <a name="a583"></a><a class="code" href="classAria.html#e18">Aria::getKeyHandler</a>()) == NULL)
  {
    keyHandler = <span class="keyword">new</span> <a class="code" href="classArKeyHandler.html">ArKeyHandler</a>;
    <a name="a584"></a><a class="code" href="classAria.html#e33">Aria::setKeyHandler</a>(keyHandler);
    myRobot-&gt;attachKeyHandler(keyHandler);
  }
  <span class="comment">// now that we have one, add our keys as callbacks, print out big</span>
  <span class="comment">// warning messages if they fail</span>
  <span class="keywordflow">if</span> (!keyHandler-&gt;<a name="a585"></a><a class="code" href="classArKeyHandler.html#a0">addKeyHandler</a>(<a name="a586"></a><a class="code" href="classArKeyHandler.html#w22w29">ArKeyHandler::UP</a>, &amp;myUpCB))
    <a name="a587"></a><a class="code" href="classArLog.html#e4">ArLog::log</a>(<a name="a588"></a><a class="code" href="classArLog.html#w2w8">ArLog::Terse</a>, <span class="stringliteral">"The key handler already has a key for up, keydrive will not work correctly."</span>);
  <span class="keywordflow">if</span> (!keyHandler-&gt;<a class="code" href="classArKeyHandler.html#a0">addKeyHandler</a>(<a name="a589"></a><a class="code" href="classArKeyHandler.html#w22w4">ArKeyHandler::DOWN</a>, &amp;myDownCB))
    <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w8">ArLog::Terse</a>, <span class="stringliteral">"The key handler already has a key for down, keydrive will not work correctly."</span>);
  <span class="keywordflow">if</span> (!keyHandler-&gt;<a class="code" href="classArKeyHandler.html#a0">addKeyHandler</a>(<a name="a590"></a><a class="code" href="classArKeyHandler.html#w22w23">ArKeyHandler::LEFT</a>, &amp;myLeftCB))
    <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w8">ArLog::Terse</a>,  
<span class="stringliteral">"The key handler already has a key for left, keydrive will not work correctly."</span>);
  <span class="keywordflow">if</span> (!keyHandler-&gt;<a class="code" href="classArKeyHandler.html#a0">addKeyHandler</a>(<a name="a591"></a><a class="code" href="classArKeyHandler.html#w22w26">ArKeyHandler::RIGHT</a>, &amp;myRightCB))
    <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w8">ArLog::Terse</a>,  
<span class="stringliteral">"The key handler already has a key for right, keydrive will not work correctly."</span>);
  <span class="keywordflow">if</span> (!keyHandler-&gt;<a class="code" href="classArKeyHandler.html#a0">addKeyHandler</a>(<span class="charliteral">'z'</span>, &amp;myInCB))
    <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w8">ArLog::Terse</a>,  
<span class="stringliteral">"The key handler already has a key for 'z', keydrive will not work correctly."</span>);
  <span class="keywordflow">if</span> (!keyHandler-&gt;<a class="code" href="classArKeyHandler.html#a0">addKeyHandler</a>(<span class="charliteral">'Z'</span>, &amp;myInCB))
    <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w8">ArLog::Terse</a>,  
<span class="stringliteral">"The key handler already has a key for 'Z', keydrive will not work correctly."</span>);
  <span class="keywordflow">if</span> (!keyHandler-&gt;<a class="code" href="classArKeyHandler.html#a0">addKeyHandler</a>(<span class="charliteral">'x'</span>, &amp;myOutCB))
    <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w8">ArLog::Terse</a>,  
<span class="stringliteral">"The key handler already has a key for 'x', keydrive will not work correctly."</span>);
  <span class="keywordflow">if</span> (!keyHandler-&gt;<a class="code" href="classArKeyHandler.html#a0">addKeyHandler</a>(<span class="charliteral">'X'</span>, &amp;myOutCB))
    <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w8">ArLog::Terse</a>,  
<span class="stringliteral">"The key handler already has a key for 'X', keydrive will not work correctly."</span>);
  <span class="keywordflow">if</span> (!keyHandler-&gt;<a class="code" href="classArKeyHandler.html#a0">addKeyHandler</a>(<span class="charliteral">'c'</span>, &amp;myCenterCB))
    <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w8">ArLog::Terse</a>,  
<span class="stringliteral">"The key handler already has a key for 'c', keydrive will not work correctly."</span>);
  <span class="keywordflow">if</span> (!keyHandler-&gt;<a class="code" href="classArKeyHandler.html#a0">addKeyHandler</a>(<span class="charliteral">'C'</span>, &amp;myCenterCB))
    <a class="code" href="classArLog.html#e4">ArLog::log</a>(<a class="code" href="classArLog.html#w2w8">ArLog::Terse</a>,  
<span class="stringliteral">"The key handler already has a key for 'C', keydrive will not work correctly."</span>);


  <span class="comment">// initialize the joystick</span>
  myJoyHandler.init();
  <span class="comment">// see if we have a joystick, and let the usre know the results</span>
  <span class="keywordflow">if</span> (myJoyHandler.haveJoystick())
  {
    printf(<span class="stringliteral">"Have a joystick\n\n"</span>);
  }
  <span class="comment">// we don't have a joystic, so get out</span>
  <span class="keywordflow">else</span>
  {
    printf(<span class="stringliteral">"Do not have a joystick, only the keyboard will work.\n"</span>);
  }
}

<span class="keywordtype">void</span> Joydrive::left(<span class="keywordtype">void</span>)
{
  myCam.panTiltRel(-myLRAmount, 0);
}

<span class="keywordtype">void</span> Joydrive::right(<span class="keywordtype">void</span>)
{
  myCam.panTiltRel(myLRAmount, 0);
}

<span class="keywordtype">void</span> Joydrive::up(<span class="keywordtype">void</span>)
{
  myCam.panTiltRel(0, myUDAmount);
}

<span class="keywordtype">void</span> Joydrive::down(<span class="keywordtype">void</span>)
{
  myCam.panTiltRel(0, -myUDAmount);
}

<span class="keywordtype">void</span> Joydrive::in(<span class="keywordtype">void</span>)
{
  myCam.zoomRel(myZoomAmount);
}

<span class="keywordtype">void</span> Joydrive::out(<span class="keywordtype">void</span>)
{
  myCam.zoomRel(-myZoomAmount);
}

<span class="keywordtype">void</span> Joydrive::center(<span class="keywordtype">void</span>)
{
  myCam.panTilt(0,0);
  myCam.zoom(0);
}

<span class="keywordtype">void</span> Joydrive::drive(<span class="keywordtype">void</span>)
{
  <span class="keywordtype">int</span> trans, rot;
  <span class="keywordtype">int</span> pan, tilt;
  <span class="keywordtype">int</span> zoom, nothing;

  <span class="comment">// if both buttons are pushed, zoom the joystick</span>
  <span class="keywordflow">if</span> (myJoyHandler.haveJoystick() &amp;&amp; myJoyHandler.getButton(1) &amp;&amp; 
      myJoyHandler.getButton(2))
  {
    <span class="comment">// set its speed so we get desired value range, we only care about y</span>
    myJoyHandler.setSpeeds(0, myZoomValCamera);
    <span class="comment">// get the values</span>
    myJoyHandler.getAdjusted(&amp;nothing, &amp;zoom);
    <span class="comment">// zoom the camera</span>
    myCam.zoomRel(zoom);
  }
  <span class="comment">// if both buttons aren't pushed, see if one button is pushed</span>
  <span class="keywordflow">else</span> 
  {
    <span class="comment">// if button one is pushed, drive the robot</span>
    <span class="keywordflow">if</span> (myJoyHandler.haveJoystick() &amp;&amp; myJoyHandler.getButton(1))
    {
      <span class="comment">// set the speed on the joystick so we get the values we want</span>
      myJoyHandler.setSpeeds(myRotValRobot, myTransValRobot);
      <span class="comment">// get the values</span>
      myJoyHandler.getAdjusted(&amp;rot, &amp;trans);
      <span class="comment">// set the robots speed</span>
      myRobot-&gt;setVel(trans);
      myRobot-&gt;setRotVel(-rot);
    }
    <span class="comment">// if button one isn't pushed, stop the robot</span>
    <span class="keywordflow">else</span>
    {
      myRobot-&gt;setVel(0);
      myRobot-&gt;setRotVel(0);
    }
    <span class="comment">// if button two is pushed, move the camera</span>
    <span class="keywordflow">if</span> (myJoyHandler.haveJoystick() &amp;&amp; myJoyHandler.getButton(2))
    {
      <span class="comment">// set the speeds on the joystick so we get desired value range</span>
      myJoyHandler.setSpeeds(myPanValCamera, myTiltValCamera);
      <span class="comment">// get the values</span>
      myJoyHandler.getAdjusted(&amp;pan, &amp;tilt);
      <span class="comment">// drive the camera</span>
      myCam.panTiltRel(pan, tilt);
    } 
  }

}

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) 
{
  <span class="comment">// just some stuff for returns</span>
  std::string str;
  <span class="keywordtype">int</span> ret;
  
  <span class="comment">// robots connection</span>
  <a name="_a592"></a><a class="code" href="classArSerialConnection.html">ArSerialConnection</a> con;
  <span class="comment">// the robot, this turns state reflection off</span>
  <a class="code" href="classArRobot.html">ArRobot</a> robot(NULL, <span class="keyword">false</span>);
  <span class="comment">// the joydrive as defined above, this also adds itself as a user task</span>
  Joydrive joyd(&amp;robot);

  <span class="comment">// mandatory init</span>
  <a name="a593"></a><a class="code" href="classAria.html#e23">Aria::init</a>();

  <span class="comment">// open the connection, if it fails, exit</span>
  <span class="keywordflow">if</span> ((ret = con.<a name="a594"></a><a class="code" href="classArSerialConnection.html#a14">open</a>()) != 0)
  {
    str = con.<a name="a595"></a><a class="code" href="classArSerialConnection.html#a7">getOpenMessage</a>(ret);
    printf(<span class="stringliteral">"Open failed: %s\n"</span>, str.c_str());
    <a name="a596"></a><a class="code" href="classAria.html#e37">Aria::shutdown</a>();
    <span class="keywordflow">return</span> 1;
  }

  <span class="comment">// set the connection o nthe robot</span>
  robot.<a name="a597"></a><a class="code" href="classArRobot.html#a275">setDeviceConnection</a>(&amp;con);
  <span class="comment">// connect, if we fail, exit</span>
  <span class="keywordflow">if</span> (!robot.<a name="a598"></a><a class="code" href="classArRobot.html#a21">blockingConnect</a>())
  {
    printf(<span class="stringliteral">"Could not connect to robot... exiting\n"</span>);
    <a class="code" href="classAria.html#e37">Aria::shutdown</a>();
    <span class="keywordflow">return</span> 1;
  }

  <span class="comment">// turn off the sonar, enable the motors, turn off amigobot sounds</span>
  robot.<a name="a599"></a><a class="code" href="classArRobot.html#a31">comInt</a>(<a name="a600"></a><a class="code" href="classArCommands.html#w6w75">ArCommands::SONAR</a>, 0);
  robot.<a class="code" href="classArRobot.html#a31">comInt</a>(<a name="a601"></a><a class="code" href="classArCommands.html#w6w11">ArCommands::ENABLE</a>, 1);
  robot.<a class="code" href="classArRobot.html#a31">comInt</a>(ArCommands::SOUNDTOG, 0);

  <span class="comment">// run, if we lose connection to the robot, exit</span>
  robot.<a name="a602"></a><a class="code" href="classArRobot.html#a254">run</a>(<span class="keyword">true</span>);
  
  <span class="comment">// shutdown and go away</span>
  <a class="code" href="classAria.html#e37">Aria::shutdown</a>();
  <span class="keywordflow">return</span> 0;
}

</pre></div> <hr size="1"><address style="align: right;"><small>Generated on Thu Jan 7 10:34:38 2010 for Aria by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
