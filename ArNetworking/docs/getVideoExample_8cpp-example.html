<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ArNetworking: getVideoExample.cpp</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>getVideoExample.cpp</h1>This example client requests video images from the server and saves them repeatedly to a file named "video.jpg", or to a series of files ("video1.jpg", "video2.jpg", etc.) if you give the -counter option. Give the image request rate in images per second with the -rate option (or use -1 to let the server decide when to send image; may not work with all servers).<p>
Connect to SAVserver, ACTS, or another video server to get images.<p>
To make a movie from the images, you can use ffmpeg on Linux. First run with frame rate and counter options to save multiple images: ./getVideoExample -host robothost -port 7272 -rate 20 -counter Then use ffmpeg: ffmpeg -i videod.jpeg -r 20 movie.mpeg See ffmpeg -h for full list of options.<p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include "Aria.h"</span>
<span class="preprocessor">#include "<a class="code" href="ArNetworking_8h.html">ArNetworking.h</a>"</span>

<span class="keywordtype">bool</span> <a name="a53"></a><a class="code" href="getVideoExample_8cpp.html#a0">useCounter</a> = <span class="keyword">false</span>;
<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a name="a54"></a><a class="code" href="getVideoExample_8cpp.html#a1">counter</a> = 1;

<span class="keywordtype">double</span> <a name="a55"></a><a class="code" href="getVideoExample_8cpp.html#a2">rate</a> = 0;
<span class="keywordtype">int</span> <a name="a56"></a><a class="code" href="getVideoExample_8cpp.html#a3">rateAsTime</a> = 0;

<span class="keywordtype">void</span> <a name="a57"></a><a class="code" href="getVideoExample_8cpp.html#a4">jpegHandler</a>(<a name="_a58"></a><a class="code" href="classArNetPacket.html">ArNetPacket</a> *packet)
{
  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> width;
  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> height;
  <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> jpeg[50000];
  <span class="keywordtype">int</span> jpegSize;
  FILE *<a name="a59"></a><a class="code" href="configClientToServer_8cpp.html#a2">file</a>;

  width = packet-&gt;<a name="a60"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArBasePacket.html#a9">bufToUByte2</a>();
  height = packet-&gt;<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArBasePacket.html#a9">bufToUByte2</a>();
  jpegSize = packet-&gt;<a name="a61"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArBasePacket.html#a20">getDataLength</a>() - packet-&gt;<a name="a62"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArBasePacket.html#a21">getDataReadLength</a>();
  <span class="keywordflow">if</span>(jpegSize &gt; 50000)
  {
    <a name="a63"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#e4">ArLog::log</a>(<a name="a64"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#w2w5">ArLog::Normal</a>, <span class="stringliteral">"Cannot save image, it's too big. (image is %d bytes, my buffer is 50000 bytes)"</span>, jpegSize);
    <span class="keywordflow">return</span>;
  }
  packet-&gt;<a name="a65"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArBasePacket.html#a5">bufToData</a>((<span class="keywordtype">char</span> *)jpeg, jpegSize);
  <span class="keywordtype">char</span> filename[128];
  <span class="keywordtype">char</span> tmpFilename[128];
  sprintf(tmpFilename, <span class="stringliteral">"tmp.jpg"</span>);
  <span class="keywordflow">if</span> ((file = <a name="a66"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArUtil.html#e21">ArUtil::fopen</a>(tmpFilename, <span class="stringliteral">"wb"</span>)) != NULL)
  {
    fwrite(jpeg, jpegSize, 1, file);
    fclose(file);
    <span class="keywordflow">if</span>(useCounter)
      snprintf(filename, 64, <span class="stringliteral">"video%lu.jpg"</span>, counter++);
    <span class="keywordflow">else</span>
      strcpy(filename, <span class="stringliteral">"video.jpg"</span>);
<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>    <span class="comment">// On windows, rename() fails if the new file already exists</span>
    unlink(filename);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (rename(tmpFilename, filename) == 0)
      <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#e4">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#w2w5">ArLog::Normal</a>, <span class="stringliteral">"Wrote a %dx%d image, %d bytes, named %s."</span>, width, height, jpegSize, filename);
    <span class="keywordflow">else</span>
      <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#e4">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#w2w5">ArLog::Normal</a>, <span class="stringliteral">"Wrote a %dx%d image, %d bytes, named %s (could not rename to real name)."</span>, width, height, jpegSize, tmpFilename);
  }
  <span class="keywordflow">else</span>
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#e4">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#w2w5">ArLog::Normal</a>, <span class="stringliteral">"Could not write temp file %s"</span>, tmpFilename);

  <span class="keywordflow">if</span> (rate == 0 || rateAsTime == 0)
  {
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#e4">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#w2w5">ArLog::Normal</a>, <span class="stringliteral">"Only one frame was requested, so exiting"</span>);
    <a name="a67"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e11">Aria::exit</a>(0);
  }
}

<span class="keywordtype">int</span> <a name="a68"></a><a class="code" href="clientCommandLister_8cpp.html#a0">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
{

<span class="preprocessor">#ifndef WIN32</span>
<span class="preprocessor"></span>  <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArDaemonizer.html">ArDaemonizer</a> daemonizer(&amp;argc, argv);
  <span class="keywordtype">bool</span> isDaemonized = <span class="keyword">false</span>;
  <span class="keywordflow">if</span> (!daemonizer.daemonize())
  {
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#e4">ArLog::log</a>(<a name="a69"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#w2w8">ArLog::Terse</a>, <span class="stringliteral">"Could not daemonize process"</span>);
    exit(1);
  }
  <span class="keywordflow">if</span> (daemonizer.isDaemonized())
    isDaemonized = <span class="keyword">true</span>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <a name="a70"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e23">Aria::init</a>();
  <a name="a71"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#e3">ArLog::init</a>(<a name="a72"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#w3w1">ArLog::File</a>, <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#w2w5">ArLog::Normal</a>, <span class="stringliteral">"getVideoLog.txt"</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>);
  
  <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArArgumentParser.html">ArArgumentParser</a> argParser(&amp;argc, argv);
  argParser.loadDefaultArguments();

  <a name="_a73"></a><a class="code" href="classArClientSimpleConnector.html">ArClientSimpleConnector</a> clientConnector(&amp;argParser);

  <span class="keywordflow">if</span>(argParser.checkParameterArgumentDouble(<span class="stringliteral">"-rate"</span>, &amp;rate))
  {
    rateAsTime = <a name="a74"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArMath.html#e15">ArMath::roundInt</a>(1000.0 / rate);
  }

  useCounter = argParser.checkArgument(<span class="stringliteral">"-counter"</span>);

  <span class="keywordflow">if</span>(!<a name="a75"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e28">Aria::parseArgs</a>() || !argParser.checkHelpAndWarnUnparsed())
  {
    <a name="a76"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e27">Aria::logOptions</a>();
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#e4">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#w2w8">ArLog::Terse</a>, <span class="stringliteral">"\n\n%s options:\n-rate &lt;FramesPerSecondAsDouble&gt; (If this isn't given, then the program will take one frame then exit, note that it is a double (so you can do .5 to do one frame per 2 seconds) and that if you set it to be too fast you'll saturate the robot's bandwidth and make it useless)\n-counter (default no)\n"</span>, argv[0]);

    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#e4">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#w2w8">ArLog::Terse</a>, <span class="stringliteral">"\n\nNotes:\nThis program saves the images as video.jpg if you aren't using a counter, or video&lt;counter&gt;.jpg if you are using the counter.\nIt puts its logs into getVideoLog.txt, and overwrites it whenever it runs\n"</span>);
    
    <span class="keywordflow">return</span> 1;
  }
  


  <a name="_a77"></a><a class="code" href="classArClientBase.html">ArClientBase</a> client;
  <span class="keywordflow">if</span> (!clientConnector.connectClient(&amp;client))
  {
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#e4">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#w2w5">ArLog::Normal</a>, <span class="stringliteral">"Could not connect to server, exiting\n"</span>);
    exit(1);
  }    

  <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArGlobalFunctor1.html">ArGlobalFunctor1&lt;ArNetPacket *&gt;</a> jpegHandlerCB(&amp;<a class="code" href="getVideoExample_8cpp.html#a4">jpegHandler</a>);

  <span class="keywordflow">if</span>(client.<a name="a78"></a><a class="code" href="classArClientBase.html#a6">dataExists</a>(<span class="stringliteral">"getPictureCam1"</span>))
  {
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#e4">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#w2w5">ArLog::Normal</a>, <span class="stringliteral">"Requesting images using \"getPictureCam1\" request."</span>);
    client.<a name="a79"></a><a class="code" href="classArClientBase.html#a2">addHandler</a>(<span class="stringliteral">"getPictureCam1"</span>, &amp;jpegHandlerCB);
    <span class="keywordflow">if</span> (rate != 0 &amp;&amp; rateAsTime != 0)
      client.<a name="a80"></a><a class="code" href="classArClientBase.html#a46">request</a>(<span class="stringliteral">"getPictureCam1"</span>, rateAsTime); 
    <span class="keywordflow">else</span>
      client.<a name="a81"></a><a class="code" href="classArClientBase.html#a48">requestOnce</a>(<span class="stringliteral">"getPictureCam1"</span>);
  } 
  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(client.<a class="code" href="classArClientBase.html#a6">dataExists</a>(<span class="stringliteral">"sendVideo"</span>))
  {
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#e4">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#w2w5">ArLog::Normal</a>, <span class="stringliteral">"Server does not have \"getPictureCam1\" request, requesting images using old \"sendVideo\" request."</span>);
    client.<a class="code" href="classArClientBase.html#a2">addHandler</a>(<span class="stringliteral">"sendVideo"</span>, &amp;jpegHandlerCB);
    <span class="keywordflow">if</span> (rate != 0 &amp;&amp; rateAsTime != 0)
      client.<a class="code" href="classArClientBase.html#a46">request</a>(<span class="stringliteral">"sendVideo"</span>, rate); 
    <span class="keywordflow">else</span>
      client.<a class="code" href="classArClientBase.html#a48">requestOnce</a>(<span class="stringliteral">"sendVideo"</span>); 
  }
  <span class="keywordflow">else</span>
  {
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#e4">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#w2w8">ArLog::Terse</a>, <span class="stringliteral">"Error: Server does not have \"getPictureCam1\" or \"sendVideo\" request, cannot request images."</span>);
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e11">Aria::exit</a>(2);
  }


  client.<a name="a82"></a><a class="code" href="classArClientBase.html#a56">run</a>();

  <a name="a83"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e37">Aria::shutdown</a>();
  <span class="keywordflow">return</span> 0;
}



</pre></div> <hr size="1"><address style="align: right;"><small>Generated on Thu Jan 7 10:34:55 2010 for ArNetworking by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
