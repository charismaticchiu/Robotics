<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ArNetworking: serverDemo.cpp</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>serverDemo.cpp</h1>Example ArNetworking server providing teleoperation, sonar data, control the camera, etc.<p>
This is a basic ArNetworking server. It connects to a robot or simulator, including, if available, IRs, gyro, and bumpers. Give the option "-connectLaser" on the command line to enable the laser rangefinder, if available.<p>
Run "./serverDemo -help" for a full list of command line options.<p>
Once running, connect to this server with a a client such as MobileEyes.<p>
This server provides the following services:<ul>
<li>User login (optional)</li><li>Basic robot telemetry information</li><li>Range sensor data values (not used by MobileEyes)</li><li>Graphics representing range sensor reading positions</li><li>Teleoperation modes (including safe/unsafe drive modes)</li><li>Wander mode</li><li>Various advanced "custom" commands to control logging, debugging, etc.</li><li>If an ACTS or SAV server is running, forward the video stream</li><li>Camera control (pan/tilt/zoom) if cameras are available</li></ul>
<p>
Note that this program requires a terminal to run -- i.e. you can't run it in the background in Linux. To modify it to allow that, remove the key handler code in <a class="el" href="clientCommandLister_8cpp.html#a0">main()</a>.<p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include "Aria.h"</span>
<span class="preprocessor">#include "<a class="code" href="ArNetworking_8h.html">ArNetworking.h</a>"</span>

<span class="keywordtype">int</span> <a name="a180"></a><a class="code" href="clientCommandLister_8cpp.html#a0">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
{
  <span class="comment">// mandatory init</span>
  <a name="a181"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e23">Aria::init</a>();

  <span class="comment">//ArLog::init(ArLog::StdOut, ArLog::Verbose);</span>

  <span class="comment">// set up our parser</span>
  <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArArgumentParser.html">ArArgumentParser</a> parser(&amp;argc, argv);

  <span class="comment">// load the default arguments </span>
  parser.loadDefaultArguments();

  <span class="comment">// robot</span>
  <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArRobot.html">ArRobot</a> robot;
  <span class="comment">// set up our simple connector</span>
  <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArRobotConnector.html">ArRobotConnector</a> robotConnector(&amp;parser, &amp;robot);


  <span class="comment">// add a gyro, it'll see if it should attach to the robot or not</span>
  <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArAnalogGyro.html">ArAnalogGyro</a> gyro(&amp;robot);


  <span class="comment">// set up the robot for connecting</span>
  <span class="keywordflow">if</span> (!robotConnector.connectRobot())
  {
    printf(<span class="stringliteral">"Could not connect to robot... exiting\n"</span>);
    <a name="a182"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e11">Aria::exit</a>(1);
  }

  <span class="comment">// our base server object</span>
  <a name="_a183"></a><a class="code" href="classArServerBase.html">ArServerBase</a> server;

  <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLaserConnector.html">ArLaserConnector</a> laserConnector(&amp;parser, &amp;robot, &amp;robotConnector);
  <a name="_a184"></a><a class="code" href="classArServerSimpleOpener.html">ArServerSimpleOpener</a> simpleOpener(&amp;parser);


  <a name="_a185"></a><a class="code" href="classArClientSwitchManager.html">ArClientSwitchManager</a> clientSwitchManager(&amp;server, &amp;parser);

  <span class="comment">// parse the command line... fail and print the help if the parsing fails</span>
  <span class="comment">// or if the help was requested</span>
  <span class="keywordflow">if</span> (!<a name="a186"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e28">Aria::parseArgs</a>() || !parser.checkHelpAndWarnUnparsed())
  {    
    <a name="a187"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e27">Aria::logOptions</a>();
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e11">Aria::exit</a>(1);
  }

  <span class="comment">// Set up where we'll look for files such as user/password </span>
  <span class="keywordtype">char</span> fileDir[1024];
  <a name="a188"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArUtil.html#e0">ArUtil::addDirectories</a>(fileDir, <span class="keyword">sizeof</span>(fileDir), <a name="a189"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e15">Aria::getDirectory</a>(), 
                         <span class="stringliteral">"ArNetworking/examples"</span>);

  <span class="comment">// first open the server up</span>
  <span class="keywordflow">if</span> (!simpleOpener.open(&amp;server, fileDir, 240))
  {
    <span class="keywordflow">if</span> (simpleOpener.wasUserFileBad())
      printf(<span class="stringliteral">"Bad user/password/permissions file\n"</span>);
    <span class="keywordflow">else</span>
      printf(<span class="stringliteral">"Could not open server port\n"</span>);
    exit(1);
  }

  <span class="comment">// Range devices:</span>
  
  <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArSonarDevice.html">ArSonarDevice</a> sonarDev;
  robot.<a name="a190"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArRobot.html#a8">addRangeDevice</a>(&amp;sonarDev);

  <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArIRs.html">ArIRs</a> irs;
  robot.<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArRobot.html#a8">addRangeDevice</a>(&amp;irs);

  <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArBumpers.html">ArBumpers</a> bumpers;
  robot.<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArRobot.html#a8">addRangeDevice</a>(&amp;bumpers);

  <span class="comment">// attach services to the server</span>
  <a name="_a191"></a><a class="code" href="classArServerInfoRobot.html">ArServerInfoRobot</a> serverInfoRobot(&amp;server, &amp;robot);
  <a name="_a192"></a><a class="code" href="classArServerInfoSensor.html">ArServerInfoSensor</a> serverInfoSensor(&amp;server, &amp;robot);
  <a name="_a193"></a><a class="code" href="classArServerInfoDrawings.html">ArServerInfoDrawings</a> drawings(&amp;server);

  <span class="comment">// modes for controlling robot movement</span>
  <a name="_a194"></a><a class="code" href="classArServerModeStop.html">ArServerModeStop</a> modeStop(&amp;server, &amp;robot);
  <a name="_a195"></a><a class="code" href="classArServerModeRatioDrive.html">ArServerModeRatioDrive</a> modeRatioDrive(&amp;server, &amp;robot);  
  <a name="_a196"></a><a class="code" href="classArServerModeWander.html">ArServerModeWander</a> modeWander(&amp;server, &amp;robot);
  modeStop.addAsDefaultMode();
  modeStop.activate();

  <span class="comment">// set up the simple commands</span>
  <a name="_a197"></a><a class="code" href="classArServerHandlerCommands.html">ArServerHandlerCommands</a> commands(&amp;server);
  <a name="_a198"></a><a class="code" href="classArServerSimpleComUC.html">ArServerSimpleComUC</a> uCCommands(&amp;commands, &amp;robot);  <span class="comment">// send commands directly to microcontroller</span>
  <a name="_a199"></a><a class="code" href="classArServerSimpleComMovementLogging.html">ArServerSimpleComMovementLogging</a> loggingCommands(&amp;commands, &amp;robot); <span class="comment">// control debug logging</span>
  <a name="_a200"></a><a class="code" href="classArServerSimpleComGyro.html">ArServerSimpleComGyro</a> gyroCommands(&amp;commands, &amp;robot, &amp;gyro); <span class="comment">// configure gyro</span>
  <a name="_a201"></a><a class="code" href="classArServerSimpleComLogRobotConfig.html">ArServerSimpleComLogRobotConfig</a> configCommands(&amp;commands, &amp;robot); <span class="comment">// control more debug logging</span>
  <a name="_a202"></a><a class="code" href="classArServerSimpleServerCommands.html">ArServerSimpleServerCommands</a> serverCommands(&amp;commands, &amp;server); <span class="comment">// control ArNetworking debug logging</span>
  <a name="_a203"></a><a class="code" href="classArServerSimpleLogRobotDebugPackets.html">ArServerSimpleLogRobotDebugPackets</a> logRobotDebugPackets(&amp;commands, &amp;robot, <span class="stringliteral">"."</span>);  <span class="comment">// debugging tool</span>

  <span class="comment">// This is an older drive mode. ArServerModeDrive is newer and generally performs better,</span>
  <span class="comment">// but you can use this for old clients if neccesary.</span>
  <span class="comment">//ArServerModeDrive modeDrive(&amp;server, &amp;robot);</span>
  <span class="comment">//modeDrive.addControlCommands(&amp;commands); // configure the drive modes (e.g. enable/disable safe drive)</span>

  <a name="_a204"></a><a class="code" href="classArServerHandlerConfig.html">ArServerHandlerConfig</a> serverHandlerConfig(&amp;server, <a name="a205"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e14">Aria::getConfig</a>()); <span class="comment">// make a config handler</span>
  <a name="a206"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#e0">ArLog::addToConfig</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e14">Aria::getConfig</a>()); <span class="comment">// let people configure logging</span>

  <span class="comment">// Forward video if either ACTS or SAV server are running.</span>
  <span class="comment">// You can find out more about SAV and ACTS on our website</span>
  <span class="comment">// http://robots.activmedia.com. ACTS is for color tracking and is</span>
  <span class="comment">// a separate product. SAV just does software A/V transmitting and is</span>
  <span class="comment">// free to all our customers. Just run ACTS or SAV server before you</span>
  <span class="comment">// start this program and this class here will forward video from the</span>
  <span class="comment">// server to the client.</span>
  <a name="_a207"></a><a class="code" href="classArHybridForwarderVideo.html">ArHybridForwarderVideo</a> videoForwarder(&amp;server, <span class="stringliteral">"localhost"</span>, 7070);
  
  <span class="comment">// Control a pan/tilt/zoom camera, if one is installed, and the video</span>
  <span class="comment">// forwarder was enabled above.</span>
  <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArPTZ.html">ArPTZ</a> *camera = NULL;
  <a name="_a208"></a><a class="code" href="classArServerHandlerCamera.html">ArServerHandlerCamera</a> *handlerCamera = NULL;
  <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArCameraCollection.html">ArCameraCollection</a> *cameraCollection = NULL;
  <span class="keywordflow">if</span> (videoForwarder.isForwardingVideo())
  {
    <span class="keywordtype">bool</span> invertedCamera = <span class="keyword">false</span>;
    camera = <span class="keyword">new</span> <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArVCC4.html">ArVCC4</a>(&amp;robot, invertedCamera, 
                        ArVCC4::COMM_UNKNOWN, <span class="keyword">true</span>, <span class="keyword">true</span>);
    camera-&gt;<a name="a209"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArPTZ.html#a23">init</a>();

    cameraCollection = <span class="keyword">new</span> <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArCameraCollection.html">ArCameraCollection</a>();
    cameraCollection-&gt;<a name="a210"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArCameraCollection.html#a0">addCamera</a>(<span class="stringliteral">"Cam1"</span>, <span class="stringliteral">"VCC4"</span>, <span class="stringliteral">"Camera"</span>, <span class="stringliteral">"VCC4"</span>);
    handlerCamera = <span class="keyword">new</span> <a class="code" href="classArServerHandlerCamera.html">ArServerHandlerCamera</a>(<span class="stringliteral">"Cam1"</span>, 
                                              &amp;server, 
                                              &amp;robot,
                                              camera, 
                                              cameraCollection);
  }

  <span class="comment">// You can use this class to send a set of arbitrary strings </span>
  <span class="comment">// for MobileEyes to display, this is just a small example</span>
  <a name="_a211"></a><a class="code" href="classArServerInfoStrings.html">ArServerInfoStrings</a> stringInfo(&amp;server);
  <a name="a212"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e16">Aria::getInfoGroup</a>()-&gt;addAddStringCallback(stringInfo.getAddStringFunctor());
  <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e16">Aria::getInfoGroup</a>()-&gt;addStringInt(
          <span class="stringliteral">"Motor Packet Count"</span>, 10, 
          <span class="keyword">new</span> <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArConstRetFunctorC.html">ArConstRetFunctorC&lt;int, ArRobot&gt;</a>(&amp;robot, 
                                               &amp;<a name="a213"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArRobot.html#a119">ArRobot::getMotorPacCount</a>));
  <span class="comment">/*</span>
<span class="comment">  Aria::getInfoGroup()-&gt;addStringInt(</span>
<span class="comment">          "Laser Packet Count", 10, </span>
<span class="comment">          new ArRetFunctorC&lt;int, ArSick&gt;(&amp;sick, </span>
<span class="comment">                                         &amp;ArSick::getSickPacCount));</span>
<span class="comment">  */</span>
  
  <span class="comment">// start the robot running, true means that if we lose connection the run thread stops</span>
  robot.enableMotors();
  robot.runAsync(<span class="keyword">true</span>);


  <span class="comment">// connect the laser(s) if it was requested</span>
  <span class="keywordflow">if</span> (!laserConnector.connectLasers())
  {
    printf(<span class="stringliteral">"Could not connect to lasers... exiting\n"</span>);
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e11">Aria::exit</a>(2);
  }
  

  drawings.addRobotsRangeDevices(&amp;robot);

  <span class="comment">// log whatever we wanted to before the runAsync</span>
  simpleOpener.checkAndLog();
  <span class="comment">// now let it spin off in its own thread</span>
  server.<a name="a214"></a><a class="code" href="classArServerBase.html#a51">runAsync</a>();

  printf(<span class="stringliteral">"Server is now running...\n"</span>);

  <span class="comment">// Add a key handler so that you can exit by pressing</span>
  <span class="comment">// escape. Note that a key handler prevents you from running</span>
  <span class="comment">// a program in the background on Linux, since it expects an </span>
  <span class="comment">// active terminal to read keys from; remove this if you want</span>
  <span class="comment">// to run it in the background.</span>
  <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArKeyHandler.html">ArKeyHandler</a> *keyHandler;
  <span class="keywordflow">if</span> ((keyHandler = <a name="a215"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e18">Aria::getKeyHandler</a>()) == NULL)
  {
    keyHandler = <span class="keyword">new</span> <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArKeyHandler.html">ArKeyHandler</a>;
    <a name="a216"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e33">Aria::setKeyHandler</a>(keyHandler);
    robot.lock();
    robot.attachKeyHandler(keyHandler);
    robot.unlock();
    printf(<span class="stringliteral">"To exit, press escape.\n"</span>);
  }

  clientSwitchManager.runAsync();

  robot.waitForRunExit();
  <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#e11">Aria::exit</a>(0);
}


</pre></div> <hr size="1"><address style="align: right;"><small>Generated on Thu Jan 7 10:34:55 2010 for ArNetworking by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
